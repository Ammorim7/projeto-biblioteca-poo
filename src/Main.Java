import arvore.ArvoreAVLGeneric;
import modelo.*;
import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;
import java.time.LocalDate;

public class Main {
    private static ArvoreAVLGeneric<modelo.Livro, String> arvoreLivros = new ArvoreAVLGeneric<>(modelo.Livro::getIsbn);
    private static ArvoreAVLGeneric<modelo.Autor, Integer> arvoreAutores = new ArvoreAVLGeneric<>(modelo.Autor::getId);
    // Estruturas para outras entidades
    private static ArvoreAVLGeneric<modelo.Usuario, Integer> arvoreUsuarios = new ArvoreAVLGeneric<>(modelo.Usuario::getMatricula);
    private static ArvoreAVLGeneric<modelo.Categoria, Integer> arvoreCategorias = new ArvoreAVLGeneric<>(modelo.Categoria::getId);
    private static List<Emprestimo> emprestimos = new ArrayList<>();
    
    private static Scanner scanner = new Scanner(System.in);
    private static int proximoIdAutor = 1;
    private static int proximoIdCategoria = 1;

    public static void main(String[] args) {
        // --- Popula√ß√£o Inicial de Dados (para teste) ---
        Autor a1 = new Autor(proximoIdAutor++, "Machado de Assis", "Brasileiro"); arvoreAutores.inserir(a1);
        Autor a2 = new Autor(proximoIdAutor++, "Clarice Lispector", "Brasileira"); arvoreAutores.inserir(a2);
        Categoria c1 = new Categoria(proximoIdCategoria++, "Cl√°ssico"); arvoreCategorias.inserir(c1);
        Categoria c2 = new Categoria(proximoIdCategoria++, "Fic√ß√£o Cient√≠fica"); arvoreCategorias.inserir(c2);
        arvoreUsuarios.inserir(new Usuario(101, "Alice Silva", "alice@lib.com"));
        arvoreUsuarios.inserir(new Usuario(102, "Bruno Costa", "bruno@lib.com"));

        arvoreLivros.inserir(new Livro("978-8578882746", "Dom Casmurro", 1899, a1, c1));
        arvoreLivros.inserir(new Livro("978-0199535729", "O Alienista", 1882, a1, c1));
        arvoreLivros.inserir(new Livro("978-0520288285", "A Peste", 1947, new Autor(proximoIdAutor++, "Albert Camus", "Franc√™s"), c1));
        arvoreLivros.inserir(new Livro("978-0007447990", "Cem Anos de Solid√£o", 1967, new Autor(proximoIdAutor++, "Gabriel Garc√≠a M√°rquez", "Colombiano"), c1));
        
        System.out.println("üìö Sistema de Gerenciamento de Biblioteca (AVL)");
        exibirMenuPrincipal();
    }

    private static void exibirMenuPrincipal() {
        int opcao = -1;
        while (opcao != 6) {
            System.out.println("\n--- Menu Principal ---");
            System.out.println("1. Gerenciar Livros (CRUD na √Årvore AVL)");
            System.out.println("2. Gerenciar Usu√°rios (CRUD)");
            System.out.println("3. Gerenciar Autores (CRUD)");
            System.out.println("4. Gerenciar Empr√©stimos");
            System.out.println("5. Visualizar Estrutura da √Årvore AVL");
            System.out.println("6. Sair");
            System.out.print("Escolha uma op√ß√£o: ");
            
            try {
                opcao = Integer.parseInt(scanner.nextLine());
                switch (opcao) {
                        case 1: menuLivros(); break;
                        case 2: menuUsuarios(); break; 
                        case 3: menuAutores(); break; 
                        case 4: menuEmprestimos(); break;
                    case 5: visualizarArvore(); break;
                    case 6: System.out.println("Saindo do sistema. At√© logo!"); break;
                    default: System.out.println("Op√ß√£o inv√°lida.");
                }
            } catch (NumberFormatException e) {
                System.out.println("Entrada inv√°lida. Digite um n√∫mero.");
            }
        }
    }
    
    // --- Menus de Entidades ---

    private static void menuLivros() {
        int opcao = -1;
        while (opcao != 5) {
            System.out.println("\n--- Gerenciar Livros (AVL CRUD) ---");
            System.out.println("1. Inserir Livro (C)");
            System.out.println("2. Buscar Livro (R)");
            System.out.println("3. Alterar Livro (U)");
            System.out.println("4. Remover Livro (D)");
            System.out.println("5. Voltar");
            System.out.print("Escolha uma op√ß√£o: ");
            
            try {
                opcao = Integer.parseInt(scanner.nextLine());
                switch (opcao) {
                    case 1: inserirLivro(); break;
                    case 2: buscarLivro(); break;
                    case 3: alterarLivro(); break;
                    case 4: removerLivro(); break;
                    case 5: break;
                    default: System.out.println("Op√ß√£o inv√°lida.");
                }
            } catch (NumberFormatException e) {
                System.out.println("Entrada inv√°lida. Digite um n√∫mero.");
            }
        }
    }

    private static void menuEmprestimos() {
        int opcao = -1;
        while (opcao != 4) {
            System.out.println("\n--- Gerenciar Empr√©stimos ---");
            System.out.println("1. Realizar Empr√©stimo");
            System.out.println("2. Devolver Livro");
            System.out.println("3. Listar Empr√©stimos");
            System.out.println("4. Voltar");
            System.out.print("Escolha uma op√ß√£o: ");
            
            try {
                opcao = Integer.parseInt(scanner.nextLine());
                switch (opcao) {
                    case 1: realizarEmprestimo(); break;
                    case 2: devolverLivro(); break;
                    case 3: listarEmprestimos(); break;
                    case 4: break;
                    default: System.out.println("Op√ß√£o inv√°lida.");
                }
            } catch (NumberFormatException e) {
                System.out.println("Entrada inv√°lida. Digite um n√∫mero.");
            }
        }
    }
    
    // --- Fun√ß√µes CRUD Livros (AVL) ---
    
    private static void inserirLivro() {
        System.out.println("\n--- Inserir Livro ---");
        System.out.print("ISBN: ");
        String isbn = scanner.nextLine();
        
        if (arvoreLivros.buscar(isbn) != null) {
            System.out.println("‚ùå Erro: Livro com este ISBN j√° cadastrado.");
            return;
        }
        
        System.out.print("T√≠tulo: ");
        String titulo = scanner.nextLine();
        System.out.print("Ano de Publica√ß√£o: ");
        int ano = Integer.parseInt(scanner.nextLine());

        // Para simplificar, usamos o primeiro autor/categoria. O ideal seria uma busca/sele√ß√£o.
          if (arvoreAutores.listarTodos().isEmpty() || arvoreCategorias.listarTodos().isEmpty()) {
               System.out.println("‚ö†Ô∏è Cadastre Autores e Categorias primeiro.");
               return;
           }

              // Para simplicidade, usamos o primeiro autor e categoria dispon√≠veis
              Autor autorSelecionado = arvoreAutores.listarTodos().get(0);
              Categoria categoriaSelecionada = arvoreCategorias.listarTodos().get(0);

           arvoreLivros.inserir(new Livro(isbn, titulo, ano, autorSelecionado, categoriaSelecionada));
    }
    
    private static void buscarLivro() {
        System.out.println("\n--- Buscar Livro ---");
        System.out.print("Digite o ISBN do livro: ");
        String isbn = scanner.nextLine();
        
        Livro encontrado = arvoreLivros.buscar(isbn);
        if (encontrado != null) {
            System.out.println("‚úÖ Livro Encontrado:\n" + encontrado);
        } else {
            System.out.println("‚ùå Livro com ISBN " + isbn + " n√£o encontrado.");
        }
    }
    
    private static void alterarLivro() {
        System.out.println("\n--- Alterar Livro (Update) ---");
        System.out.print("Digite o ISBN do livro a ser alterado: ");
        String isbn = scanner.nextLine();
        
        Livro livro = arvoreLivros.buscar(isbn);
        if (livro != null) {
            System.out.println("Livro atual: " + livro.getTitulo() + " (" + livro.getAnoPublicacao() + ")");
            System.out.print("Novo T√≠tulo (deixe vazio para manter): ");
            String novoTitulo = scanner.nextLine();
            
            if (!novoTitulo.isEmpty()) {
                livro.setTitulo(novoTitulo);
            }
            
            System.out.print("Novo Ano de Publica√ß√£o (deixe vazio para manter): ");
            String novoAnoStr = scanner.nextLine();
            if (!novoAnoStr.isEmpty()) {
                try {
                    livro.setAnoPublicacao(Integer.parseInt(novoAnoStr));
                } catch (NumberFormatException e) {
                    System.out.println("‚ö†Ô∏è Ano inv√°lido. Manter√° o anterior.");
                }
            }
            System.out.println("‚úÖ Livro alterado com sucesso!\n" + livro);
        } else {
            System.out.println("‚ùå Livro com ISBN " + isbn + " n√£o encontrado.");
        }
    }
    
    private static void removerLivro() {
        System.out.println("\n--- Remover Livro ---");
        System.out.print("Digite o ISBN do livro a ser removido: ");
        String isbn = scanner.nextLine();
        
        arvoreLivros.remover(isbn);
    }
    
    private static void visualizarArvore() {
        System.out.println("\n--- Visualiza√ß√£o Hier√°rquica da √Årvore AVL (ISBN) ---");
        arvoreLivros.visualizarEstrutura();
    }

    // --- CRUD Autores (usando AVL) ---

    private static void menuAutores() {
        int opcao = -1;
        while (opcao != 5) {
            System.out.println("\n--- Gerenciar Autores (AVL) ---");
            System.out.println("1. Inserir Autor (C)");
            System.out.println("2. Listar Autores (R)");
            System.out.println("3. Alterar Autor (U)");
            System.out.println("4. Remover Autor (D)");
            System.out.println("5. Voltar");
            System.out.print("Escolha uma op√ß√£o: ");

            try {
                opcao = Integer.parseInt(scanner.nextLine());
                switch (opcao) {
                    case 1: inserirAutor(); break;
                    case 2: listarAutores(); break;
                    case 3: alterarAutor(); break;
                    case 4: removerAutor(); break;
                    case 5: break;
                    default: System.out.println("Op√ß√£o inv√°lida.");
                }
            } catch (NumberFormatException e) {
                System.out.println("Entrada inv√°lida. Digite um n√∫mero.");
            }
        }
    }

    private static void inserirAutor() {
        System.out.println("\n--- Inserir Autor ---");
        System.out.print("Nome: ");
        String nome = scanner.nextLine();
        System.out.print("Nacionalidade: ");
        String nacionalidade = scanner.nextLine();

        Autor novo = new Autor(proximoIdAutor++, nome, nacionalidade);
        arvoreAutores.inserir(novo);
    }

    private static void listarAutores() {
        System.out.println("\n--- Lista de Autores ---");
        for (Autor a : arvoreAutores.listarTodos()) {
            System.out.println(a);
        }
    }

    private static void alterarAutor() {
        System.out.println("\n--- Alterar Autor ---");
        System.out.print("ID do Autor: ");
        int id = Integer.parseInt(scanner.nextLine());
        Autor autor = arvoreAutores.buscar(id);
        if (autor == null) {
            System.out.println("‚ùå Autor n√£o encontrado.");
            return;
        }
        System.out.print("Novo Nome (vazio para manter): ");
        String nome = scanner.nextLine();
        if (!nome.isEmpty()) {
            arvoreAutores.remover(id);
            Autor novo = new Autor(id, nome, autor.getNacionalidade());
            arvoreAutores.inserir(novo);
        }
        System.out.print("Nova Nacionalidade (vazio para manter): ");
        String nac = scanner.nextLine();
        if (!nac.isEmpty()) {
            arvoreAutores.remover(id);
            Autor novo = new Autor(id, autor.getNome(), nac);
            arvoreAutores.inserir(novo);
        }
        System.out.println("‚úÖ Autor alterado (recriado). Consulte a lista.");
    }

    private static void removerAutor() {
        System.out.println("\n--- Remover Autor ---");
        System.out.print("ID do Autor a remover: ");
        int id = Integer.parseInt(scanner.nextLine());
        arvoreAutores.remover(id);
    }

    // --- CRUD Categoria (lista simples) ---

    private static void inserirCategoria() {
        System.out.println("\n--- Inserir Categoria ---");
        System.out.print("Nome: ");
        String nome = scanner.nextLine();
        Categoria c = new Categoria(proximoIdCategoria++, nome);
        arvoreCategorias.inserir(c);
        System.out.println("‚úÖ Categoria inserida: " + c.getNome());
    }

    private static void listarCategorias() {
        System.out.println("\n--- Lista de Categorias ---");
        for (Categoria c : arvoreCategorias.listarTodos()) System.out.println(c);
    }

    private static void alterarCategoria() {
        System.out.println("\n--- Alterar Categoria ---");
        System.out.print("ID: ");
        int id = Integer.parseInt(scanner.nextLine());
        Categoria cat = arvoreCategorias.buscar(id);
        if (cat == null) { System.out.println("‚ùå Categoria n√£o encontrada."); return; }
        System.out.print("Novo Nome (vazio para manter): ");
        String novo = scanner.nextLine();
        if (!novo.isEmpty()) {
            cat.setNome(novo);
            System.out.println("‚úÖ Categoria alterada.");
        }
    }

    private static void removerCategoria() {
        System.out.println("\n--- Remover Categoria ---");
        System.out.print("ID: ");
        int id = Integer.parseInt(scanner.nextLine());
        arvoreCategorias.remover(id);
        System.out.println("‚úÖ Se existia, categoria removida.");
    }

    // --- CRUD Usu√°rios (lista simples) ---

    private static void menuUsuarios() {
        int opcao = -1;
        while (opcao != 5) {
            System.out.println("\n--- Gerenciar Usu√°rios ---");
            System.out.println("1. Inserir Usu√°rio");
            System.out.println("2. Listar Usu√°rios");
            System.out.println("3. Alterar Usu√°rio");
            System.out.println("4. Remover Usu√°rio");
            System.out.println("5. Voltar");
            System.out.print("Escolha uma op√ß√£o: ");
            try {
                opcao = Integer.parseInt(scanner.nextLine());
                switch (opcao) {
                    case 1: inserirUsuario(); break;
                    case 2: listarUsuarios(); break;
                    case 3: alterarUsuario(); break;
                    case 4: removerUsuario(); break;
                    case 5: break;
                    default: System.out.println("Op√ß√£o inv√°lida.");
                }
            } catch (NumberFormatException e) { System.out.println("Entrada inv√°lida."); }
        }
    }

    private static void inserirUsuario() {
        System.out.println("\n--- Inserir Usu√°rio ---");
        System.out.print("Matr√≠cula (n√∫mero): ");
        int mat = Integer.parseInt(scanner.nextLine());
        System.out.print("Nome: ");
        String nome = scanner.nextLine();
        System.out.print("Email: ");
        String email = scanner.nextLine();
        arvoreUsuarios.inserir(new Usuario(mat, nome, email));
        System.out.println("‚úÖ Usu√°rio cadastrado.");
    }

    private static void listarUsuarios() {
        System.out.println("\n--- Lista de Usu√°rios ---");
        for (Usuario u : arvoreUsuarios.listarTodos()) System.out.println(u);
    }

    private static void alterarUsuario() {
        System.out.println("\n--- Alterar Usu√°rio ---");
        System.out.print("Matr√≠cula: ");
        int mat = Integer.parseInt(scanner.nextLine());
        Usuario u = arvoreUsuarios.buscar(mat);
        if (u == null) { System.out.println("‚ùå Usu√°rio n√£o encontrado."); return; }
        System.out.print("Novo Nome (vazio para manter): ");
        String nome = scanner.nextLine();
        System.out.print("Novo Email (vazio para manter): ");
        String email = scanner.nextLine();
        if (!nome.isEmpty()) u.setNome(nome);
        if (!email.isEmpty()) u.setEmail(email);
        System.out.println("‚úÖ Usu√°rio alterado.");
    }

    private static void removerUsuario() {
        System.out.println("\n--- Remover Usu√°rio ---");
        System.out.print("Matr√≠cula: ");
        int mat = Integer.parseInt(scanner.nextLine());
        arvoreUsuarios.remover(mat);
        System.out.println("‚úÖ Se existia, usu√°rio removido.");
    }

    // --- Empr√©stimos adicionais ---

    private static void listarEmprestimos() {
        System.out.println("\n--- Empr√©stimos Registrados ---");
        for (Emprestimo e : emprestimos) System.out.println(e);
    }

    // --- Fun√ß√µes Gerenciamento de Empr√©stimos ---

    private static void realizarEmprestimo() {
        System.out.println("\n--- Realizar Empr√©stimo ---");
        System.out.print("ISBN do Livro: ");
        String isbn = scanner.nextLine();
        System.out.print("Matr√≠cula do Usu√°rio (101/102): ");
        int matricula = Integer.parseInt(scanner.nextLine());
        
        Livro livro = arvoreLivros.buscar(isbn);
        Usuario usuario = arvoreUsuarios.buscar(matricula);

        if (livro == null || usuario == null) {
            System.out.println("‚ùå Livro ou Usu√°rio n√£o encontrado.");
            return;
        }
        
        if (livro.isEmprestado()) {
            System.out.println("‚ùå Livro j√° emprestado.");
            return;
        }

        LocalDate hoje = LocalDate.now();
        LocalDate devolucaoPrevista = hoje.plusDays(7);
        Emprestimo novoEmprestimo = new Emprestimo(livro, usuario, hoje, devolucaoPrevista);
        
        livro.setEmprestado(true); // Marca o livro como emprestado
        emprestimos.add(novoEmprestimo);
        
        System.out.println("‚úÖ Empr√©stimo registrado:\n" + novoEmprestimo);
    }
    
    private static void devolverLivro() {
        System.out.println("\n--- Devolver Livro ---");
        System.out.print("ISBN do Livro a ser devolvido: ");
        String isbn = scanner.nextLine();
        
        Livro livro = arvoreLivros.buscar(isbn);
        
        if (livro == null || !livro.isEmprestado()) {
            System.out.println("‚ùå Livro n√£o encontrado ou n√£o est√° emprestado.");
            return;
        }
        
        livro.setEmprestado(false); // Marca o livro como devolvido
        // Na pr√°tica, o empr√©stimo seria removido ou marcado como 'conclu√≠do'
        
        System.out.println("‚úÖ Livro '" + livro.getTitulo() + "' devolvido com sucesso.");
    }
}