import arvore.ArvoreAVL;
import modelo.*;
import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;
import java.time.LocalDate;

public class Main {
    private static ArvoreAVL arvoreLivros = new ArvoreAVL();
    // Armazenamento simples para as outras entidades (para fins de exemplo)
    private static List<Usuario> usuarios = new ArrayList<>();
    private static List<Autor> autores = new ArrayList<>();
    private static List<Categoria> categorias = new ArrayList<>();
    private static List<Emprestimo> emprestimos = new ArrayList<>();
    
    private static Scanner scanner = new Scanner(System.in);
    private static int proximoIdAutor = 1;
    private static int proximoIdCategoria = 1;

    public static void main(String[] args) {
        // --- Popula√ß√£o Inicial de Dados (para teste) ---
        Autor a1 = new Autor(proximoIdAutor++, "Machado de Assis", "Brasileiro"); autores.add(a1);
        Autor a2 = new Autor(proximoIdAutor++, "Clarice Lispector", "Brasileira"); autores.add(a2);
        Categoria c1 = new Categoria(proximoIdCategoria++, "Cl√°ssico"); categorias.add(c1);
        Categoria c2 = new Categoria(proximoIdCategoria++, "Fic√ß√£o Cient√≠fica"); categorias.add(c2);
        usuarios.add(new Usuario(101, "Alice Silva", "alice@lib.com"));
        usuarios.add(new Usuario(102, "Bruno Costa", "bruno@lib.com"));

        arvoreLivros.inserir(new Livro("978-8578882746", "Dom Casmurro", 1899, a1, c1));
        arvoreLivros.inserir(new Livro("978-0199535729", "O Alienista", 1882, a1, c1));
        arvoreLivros.inserir(new Livro("978-0520288285", "A Peste", 1947, new Autor(proximoIdAutor++, "Albert Camus", "Franc√™s"), c1));
        arvoreLivros.inserir(new Livro("978-0007447990", "Cem Anos de Solid√£o", 1967, new Autor(proximoIdAutor++, "Gabriel Garc√≠a M√°rquez", "Colombiano"), c1));
        
        System.out.println("üìö Sistema de Gerenciamento de Biblioteca (AVL)");
        exibirMenuPrincipal();
    }

    private static void exibirMenuPrincipal() {
        int opcao = -1;
        while (opcao != 6) {
            System.out.println("\n--- Menu Principal ---");
            System.out.println("1. Gerenciar Livros (CRUD na √Årvore AVL)");
            System.out.println("2. Gerenciar Usu√°rios (CRUD)");
            System.out.println("3. Gerenciar Autores (CRUD)");
            System.out.println("4. Gerenciar Empr√©stimos");
            System.out.println("5. Visualizar Estrutura da √Årvore AVL");
            System.out.println("6. Sair");
            System.out.print("Escolha uma op√ß√£o: ");
            
            try {
                opcao = Integer.parseInt(scanner.nextLine());
                switch (opcao) {
                    case 1: menuLivros(); break;
                    case 2: System.out.println("Implementar CRUD de Usu√°rios aqui..."); break; 
                    case 3: System.out.println("Implementar CRUD de Autores aqui..."); break; 
                    case 4: menuEmprestimos(); break;
                    case 5: visualizarArvore(); break;
                    case 6: System.out.println("Saindo do sistema. At√© logo!"); break;
                    default: System.out.println("Op√ß√£o inv√°lida.");
                }
            } catch (NumberFormatException e) {
                System.out.println("Entrada inv√°lida. Digite um n√∫mero.");
            }
        }
    }
    
    // --- Menus de Entidades ---

    private static void menuLivros() {
        int opcao = -1;
        while (opcao != 5) {
            System.out.println("\n--- Gerenciar Livros (AVL CRUD) ---");
            System.out.println("1. Inserir Livro (C)");
            System.out.println("2. Buscar Livro (R)");
            System.out.println("3. Alterar Livro (U)");
            System.out.println("4. Remover Livro (D)");
            System.out.println("5. Voltar");
            System.out.print("Escolha uma op√ß√£o: ");
            
            try {
                opcao = Integer.parseInt(scanner.nextLine());
                switch (opcao) {
                    case 1: inserirLivro(); break;
                    case 2: buscarLivro(); break;
                    case 3: alterarLivro(); break;
                    case 4: removerLivro(); break;
                    case 5: break;
                    default: System.out.println("Op√ß√£o inv√°lida.");
                }
            } catch (NumberFormatException e) {
                System.out.println("Entrada inv√°lida. Digite um n√∫mero.");
            }
        }
    }

    private static void menuEmprestimos() {
        int opcao = -1;
        while (opcao != 3) {
            System.out.println("\n--- Gerenciar Empr√©stimos ---");
            System.out.println("1. Realizar Empr√©stimo");
            System.out.println("2. Devolver Livro");
            System.out.println("3. Voltar");
            System.out.print("Escolha uma op√ß√£o: ");
            
            try {
                opcao = Integer.parseInt(scanner.nextLine());
                switch (opcao) {
                    case 1: realizarEmprestimo(); break;
                    case 2: devolverLivro(); break;
                    case 3: break;
                    default: System.out.println("Op√ß√£o inv√°lida.");
                }
            } catch (NumberFormatException e) {
                System.out.println("Entrada inv√°lida. Digite um n√∫mero.");
            }
        }
    }
    
    // --- Fun√ß√µes CRUD Livros (AVL) ---
    
    private static void inserirLivro() {
        System.out.println("\n--- Inserir Livro ---");
        System.out.print("ISBN: ");
        String isbn = scanner.nextLine();
        
        if (arvoreLivros.buscar(isbn) != null) {
            System.out.println("‚ùå Erro: Livro com este ISBN j√° cadastrado.");
            return;
        }
        
        System.out.print("T√≠tulo: ");
        String titulo = scanner.nextLine();
        System.out.print("Ano de Publica√ß√£o: ");
        int ano = Integer.parseInt(scanner.nextLine());

        // Para simplificar, usamos o primeiro autor/categoria. O ideal seria uma busca/sele√ß√£o.
        if (autores.isEmpty() || categorias.isEmpty()) {
             System.out.println("‚ö†Ô∏è Cadastre Autores e Categorias primeiro.");
             return;
        }

        arvoreLivros.inserir(new Livro(isbn, titulo, ano, autores.get(0), categorias.get(0)));
    }
    
    private static void buscarLivro() {
        System.out.println("\n--- Buscar Livro ---");
        System.out.print("Digite o ISBN do livro: ");
        String isbn = scanner.nextLine();
        
        Livro encontrado = arvoreLivros.buscar(isbn);
        if (encontrado != null) {
            System.out.println("‚úÖ Livro Encontrado:\n" + encontrado);
        } else {
            System.out.println("‚ùå Livro com ISBN " + isbn + " n√£o encontrado.");
        }
    }
    
    private static void alterarLivro() {
        System.out.println("\n--- Alterar Livro (Update) ---");
        System.out.print("Digite o ISBN do livro a ser alterado: ");
        String isbn = scanner.nextLine();
        
        Livro livro = arvoreLivros.buscar(isbn);
        if (livro != null) {
            System.out.println("Livro atual: " + livro.getTitulo() + " (" + livro.getAnoPublicacao() + ")");
            System.out.print("Novo T√≠tulo (deixe vazio para manter): ");
            String novoTitulo = scanner.nextLine();
            
            if (!novoTitulo.isEmpty()) {
                livro.setTitulo(novoTitulo);
            }
            
            System.out.print("Novo Ano de Publica√ß√£o (deixe vazio para manter): ");
            String novoAnoStr = scanner.nextLine();
            if (!novoAnoStr.isEmpty()) {
                try {
                    livro.setAnoPublicacao(Integer.parseInt(novoAnoStr));
                } catch (NumberFormatException e) {
                    System.out.println("‚ö†Ô∏è Ano inv√°lido. Manter√° o anterior.");
                }
            }
            System.out.println("‚úÖ Livro alterado com sucesso!\n" + livro);
        } else {
            System.out.println("‚ùå Livro com ISBN " + isbn + " n√£o encontrado.");
        }
    }
    
    private static void removerLivro() {
        System.out.println("\n--- Remover Livro ---");
        System.out.print("Digite o ISBN do livro a ser removido: ");
        String isbn = scanner.nextLine();
        
        arvoreLivros.remover(isbn);
    }
    
    private static void visualizarArvore() {
        System.out.println("\n--- Visualiza√ß√£o Hier√°rquica da √Årvore AVL (ISBN) ---");
        arvoreLivros.visualizarEstrutura();
    }

    // --- Fun√ß√µes Gerenciamento de Empr√©stimos ---

    private static void realizarEmprestimo() {
        System.out.println("\n--- Realizar Empr√©stimo ---");
        System.out.print("ISBN do Livro: ");
        String isbn = scanner.nextLine();
        System.out.print("Matr√≠cula do Usu√°rio (101/102): ");
        int matricula = Integer.parseInt(scanner.nextLine());
        
        Livro livro = arvoreLivros.buscar(isbn);
        Usuario usuario = usuarios.stream().filter(u -> u.getMatricula() == matricula).findFirst().orElse(null);

        if (livro == null || usuario == null) {
            System.out.println("‚ùå Livro ou Usu√°rio n√£o encontrado.");
            return;
        }
        
        if (livro.isEmprestado()) {
            System.out.println("‚ùå Livro j√° emprestado.");
            return;
        }

        LocalDate hoje = LocalDate.now();
        LocalDate devolucaoPrevista = hoje.plusDays(7);
        Emprestimo novoEmprestimo = new Emprestimo(livro, usuario, hoje, devolucaoPrevista);
        
        livro.setEmprestado(true); // Marca o livro como emprestado
        emprestimos.add(novoEmprestimo);
        
        System.out.println("‚úÖ Empr√©stimo registrado:\n" + novoEmprestimo);
    }
    
    private static void devolverLivro() {
        System.out.println("\n--- Devolver Livro ---");
        System.out.print("ISBN do Livro a ser devolvido: ");
        String isbn = scanner.nextLine();
        
        Livro livro = arvoreLivros.buscar(isbn);
        
        if (livro == null || !livro.isEmprestado()) {
            System.out.println("‚ùå Livro n√£o encontrado ou n√£o est√° emprestado.");
            return;
        }
        
        livro.setEmprestado(false); // Marca o livro como devolvido
        // Na pr√°tica, o empr√©stimo seria removido ou marcado como 'conclu√≠do'
        
        System.out.println("‚úÖ Livro '" + livro.getTitulo() + "' devolvido com sucesso.");
    }
}